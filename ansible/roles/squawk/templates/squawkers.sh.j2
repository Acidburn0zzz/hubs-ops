# Runs the bots for the smoke test.

NUM_SQUAWKER_PROCESSES={{ num_squawker_processes }}
CYCLE_TIME={{ cycle_time }}
PROCESS_SPAWN_DELAY={{ process_spawn_delay }}
HUBS_HOST={{ hubs_host }}
SMOKE_ROOM={{ smoke_room }}

if [ -e "squawkers.pid" ] && kill $(cat squawkers.pid) ; then
  echo "Already running, shutting down."
  sleep 5
fi

killall -9 node
killall -9 chrome

sleep 5
echo "Spawning squawkers..."

echo $$ > squawkers.pid

pushd hubs/scripts/bot

yarn 

while true; do
  for i in `seq 1 $NUM_SQUAWKER_PROCESSES`;
    do
      node ./run-bot.js \
        --room $SMOKE_ROOM \
        --host $HUBS_HOST &
      sleep $PROCESS_SPAWN_DELAY
    done    
  	
  sleep $CYCLE_TIME
  killall -9 node
  	
  sleep 1
  killall -9 chrome
  	
  sleep 2
done
